#!/bin/sh

#Discover some stuff about where we are.
START_PATH=$(pwd)
THIS_FOLDER=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
ROOT_DEPENDENCY_FOLDER=$THIS_FOLDER/..

#Configuration
GENERATOR_NAME=Xcode
SOURCE_FOLDER=$THIS_FOLDER/src
BUILD_FOLDER=$THIS_FOLDER/OSXBuild
CMAKE_SETTINGS="-D OGRE_BUILD_COMPONENT_MESHLODGENERATOR=0 \
-D OGRE_BUILD_COMPONENT_OVERLAY=0 \
-D OGRE_BUILD_COMPONENT_PAGING=0 \
-D OGRE_BUILD_COMPONENT_RTSHADERSYSTEM=0 \
-D OGRE_BUILD_COMPONENT_TERRAIN=0 \
-D OGRE_BUILD_COMPONENT_VOLUME=0 \
-D OGRE_BUILD_PLUGIN_BSP=0 \
-D OGRE_BUILD_PLUGIN_CG=0 \
-D OGRE_BUILD_PLUGIN_OCTREE=0 \
-D OGRE_BUILD_PLUGIN_PCZ=0 \
-D OGRE_BUILD_PLUGIN_PFX=0 \
-D OGRE_BUILD_RENDERSYSTEM_D3D9=0 \
-D OGRE_BUILD_SAMPLES=0 \
-D OGRE_BUILD_TOOLS=0 \
-D OGRE_COPY_DEPENDENCIES=0 \
-D OGRE_INSTALL_DEPENDENCIES=0 \
-D OGRE_INSTALL_DOCS=0 \
-D OGRE_INSTALL_PDB=0 \
-D OGRE_INSTALL_SAMPLES=0 \
-D OGRE_INSTALL_TOOLS=0 \
-D OGRE_STATIC=1 \
-D CMAKE_INSTALL_PREFIX=$BUILD_FOLDER/Install \
-D CMAKE_OSX_DEPLOYMENT_TARGET=10.7 \
-D ZLIB_LIBRARY_DBG=$ROOT_DEPENDENCY_FOLDER/OgreDeps/OSXInstall/lib/libzlib.a \
-D ZLIB_LIBRARY_REL=$ROOT_DEPENDENCY_FOLDER/OgreDeps/OSXInstall/lib/libzlib.a \
-D OGRE_DEPENDENCIES_DIR=$ROOT_DEPENDENCY_FOLDER/OgreDeps/OSXInstall"

#Make sure the build directories are empty by removing them
rm -r "$BUILD_FOLDER"

#Create the framework
mkdir "$BUILD_FOLDER"
cd "$BUILD_FOLDER"

# Small hack to remove FREEIMAGE_LIB from the preprocessor, dont want to hack up ogre cmake to support our method of building freeimge dynamically
#mono $ROOT_DEPENDENCY_FOLDER\CMakeHacks.exe replace %BuildPath% *.pbxproj ";FREEIMAGE_LIB;" ";"

cmake -G "$GENERATOR_NAME" $CMAKE_SETTINGS $SOURCE_FOLDER

#Build with XCode, note that we have to override a couple of the settings generated by CMake
xcodebuild -configuration Release SHARED_PRECOMPS_DIR="$BUILD_FOLDER/SharedTmpPCH" CLANG_CXX_LANGUAGE_STANDARD="compiler-default" CLANG_CXX_LIBRARY="compiler-default" INSTALL_PATH="@rpath" ARCHS="i386 x86_64"

#Finish up
cd "$START_PATH"